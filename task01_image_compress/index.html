<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片压缩工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            transition: all 0.3s ease;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            .drop-zone, .controls, .image-item {
                background: #2d2d2d !important;
                border-color: #444 !important;
            }
            
            .drop-zone:hover, .drop-zone.dragover {
                border-color: #007bff !important;
                background: #333 !important;
            }
            
            .image-info {
                color: #ccc !important;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .drop-zone input[type="file"] {
            display: none;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .drop-zone {
                padding: 40px 15px;
            }
            
            .drop-zone h3 {
                font-size: 18px;
            }
        }
        
        .image-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .image-info {
            font-size: 14px;
            color: #666;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>图片压缩工具</h1>
            <p>支持 JPEG/PNG/WebP 格式，纯本地处理，安全可靠</p>
        </div>
        
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" multiple accept="image/*">
            <div>
                <h3>点击选择图片或拖拽到此处</h3>
                <p>支持多张图片同时处理</p>
            </div>
        </div>
        
        <div class="controls" id="controls">
            <div class="control-group">
                <label>最大宽度:</label>
                <input type="range" id="maxWidth" min="100" max="4000" value="1920">
                <span id="widthValue">1920px</span>
            </div>
            <div class="control-group">
                <label>压缩质量:</label>
                <input type="range" id="quality" min="0.1" max="1" step="0.1" value="0.8">
                <span id="qualityValue">0.8</span>
            </div>
            <div class="control-group">
                <button class="btn btn-primary" onclick="compressAll()" id="compressBtn">开始压缩</button>
                <button class="btn btn-primary" onclick="downloadAll()" style="display:none" id="downloadBtn">下载所有</button>
                <div id="progressInfo" style="display:none; margin-left: 20px; color: #666;">
                    处理进度: <span id="progress">0</span>/<span id="total">0</span>
                </div>
            </div>
        </div>
        
        <div class="preview-grid" id="previewGrid"></div>
    </div>

    <script>
        let selectedFiles = [];
        let compressedImages = [];
        
        // 文件选择和拖拽处理
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.querySelector('.drop-zone');
        const controls = document.getElementById('controls');
        const previewGrid = document.getElementById('previewGrid');
        
        fileInput.addEventListener('change', handleFiles);
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });
        
        function handleFiles(event) {
            selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length > 0) {
                controls.style.display = 'block';
                displayPreviews();
            }
        }
        
        function displayPreviews() {
            previewGrid.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="预览">
                        <div class="image-info">
                            <div><strong>${file.name}</strong></div>
                            <div>原始大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                            <div id="status-${index}">等待压缩...</div>
                        </div>
                    `;
                    previewGrid.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 更新控制项显示值
        document.getElementById('maxWidth').oninput = function() {
            document.getElementById('widthValue').textContent = this.value + 'px';
        };
        
        document.getElementById('quality').oninput = function() {
            document.getElementById('qualityValue').textContent = this.value;
        };
        
        let processingCount = 0;
        
        function compressAll() {
            const maxWidth = parseInt(document.getElementById('maxWidth').value);
            const quality = parseFloat(document.getElementById('quality').value);
            
            compressedImages = [];
            processingCount = 0;
            
            // 显示进度信息
            document.getElementById('progressInfo').style.display = 'block';
            document.getElementById('progress').textContent = '0';
            document.getElementById('total').textContent = selectedFiles.length;
            document.getElementById('compressBtn').textContent = '压缩中...';
            document.getElementById('compressBtn').disabled = true;
            document.getElementById('downloadBtn').style.display = 'none';
            
            selectedFiles.forEach((file, index) => {
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    updateStatus(index, 0, file.size, '文件格式不支持');
                    return;
                }
                
                compressImage(file, maxWidth, quality, index);
            });
        }
        
        function compressImage(file, maxWidth, quality, index) {
            // 对于大图使用Web Worker处理
            if (file.size > 2 * 1024 * 1024) { // 2MB以上使用Worker
                compressWithWorker(file, maxWidth, quality, index);
            } else {
                compressInMainThread(file, maxWidth, quality, index);
            }
        }
        
        function compressInMainThread(file, maxWidth, quality, index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // 计算新尺寸
                let { width, height } = img;
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // 绘制压缩图片
                ctx.drawImage(img, 0, 0, width, height);
                
                // 输出压缩后的图片
                canvas.toBlob((blob) => {
                    handleCompressedResult(blob, file, index);
                }, 'image/jpeg', quality);
            };
            
            const reader = new FileReader();
            reader.onload = (e) => img.src = e.target.result;
            reader.readAsDataURL(file);
        }
        
        function compressWithWorker(file, maxWidth, quality, index) {
            const workerCode = `
                self.onmessage = function(e) {
                    const { imageData, maxWidth, quality, index } = e.data;
                    
                    const canvas = new OffscreenCanvas(1, 1);
                    const ctx = canvas.getContext('2d');
                    
                    const img = new Image();
                    img.onload = function() {
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.convertToBlob({ type: 'image/jpeg', quality: quality })
                            .then(blob => {
                                self.postMessage({ blob, index });
                            });
                    };
                    img.src = imageData;
                };
            `;
            
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const worker = new Worker(URL.createObjectURL(blob));
            
            const reader = new FileReader();
            reader.onload = function(e) {
                worker.postMessage({
                    imageData: e.target.result,
                    maxWidth: maxWidth,
                    quality: quality,
                    index: index
                });
            };
            
            worker.onmessage = function(e) {
                const { blob, index } = e.data;
                handleCompressedResult(blob, file, index);
                worker.terminate();
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleCompressedResult(blob, originalFile, index) {
            compressedImages[index] = {
                blob: blob,
                filename: originalFile.name.replace(/\.[^/.]+$/, '') + '_compressed.jpg',
                originalSize: originalFile.size,
                compressedSize: blob.size
            };
            
            processingCount++;
            updateStatus(index, blob.size, originalFile.size);
            updateProgress();
            
            if (processingCount === selectedFiles.length) {
                document.getElementById('downloadBtn').style.display = 'inline-block';
                document.getElementById('compressBtn').textContent = '开始压缩';
                document.getElementById('compressBtn').disabled = false;
            }
        }
        
        function updateProgress() {
            document.getElementById('progress').textContent = processingCount;
        }
        
        function updateStatus(index, compressedSize, originalSize, errorMsg = null) {
            if (errorMsg) {
                document.getElementById(`status-${index}`).innerHTML = `
                    <span style="color: red;">错误: ${errorMsg}</span>
                `;
                processingCount++;
                updateProgress();
                return;
            }
            
            const compressionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
            document.getElementById(`status-${index}`).innerHTML = `
                <span style="color: green;">压缩完成！</span><br>
                压缩后: ${(compressedSize / 1024 / 1024).toFixed(2)} MB<br>
                压缩率: ${compressionRatio}%
            `;
        }
        
        async function downloadAll() {
            if (compressedImages.length === 1) {
                // 单张图片直接下载
                const link = document.createElement('a');
                link.href = URL.createObjectURL(compressedImages[0].blob);
                link.download = compressedImages[0].filename;
                link.click();
            } else {
                // 多张图片打包为ZIP下载
                const zip = new JSZip();
                
                compressedImages.forEach((img, index) => {
                    if (img) {
                        zip.file(img.filename, img.blob);
                    }
                });
                
                const content = await zip.generateAsync({type: "blob"});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "compressed_images.zip";
                link.click();
            }
        }
    </script>
</body>
</html>